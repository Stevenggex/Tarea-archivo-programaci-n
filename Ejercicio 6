#include <iostream>
#include <fstream>
#include <iomanip>
#include <string>
#include <vector>
#include <sstream>
#include <ctime>

using namespace std;

struct Cliente {
	int codigo;
	string nombre;
	string tipoServicio;
	int añoAfiliacion;
	string estado;
	int codigoPlan;
};

struct Plan {
	int codigo;
	string nombre;
	int velocidadMinutos;
	double precioMensual;
};

const int MAX_CLIENTES = 20;
const int MAX_PLANES = 10;

void crearCliente(Cliente clientes[], int& numClientes) {
	if (numClientes >= MAX_CLIENTES) {
		cout << "Máximo de clientes alcanzado\n";
		return;
	}
	
	Cliente c;
	cout << "Código: "; cin >> c.codigo;
	cout << "Nombre: "; cin.ignore(); getline(cin, c.nombre);
	cout << "Tipo (Internet/Telefonía/Combo): "; cin >> c.tipoServicio;
	cout << "Año afiliación: "; cin >> c.añoAfiliacion;
	cout << "Estado (Activo/Suspendido): "; cin >> c.estado;
	cout << "Código plan: "; cin >> c.codigoPlan;
	
	clientes[numClientes] = c;
	numClientes++;
	
	ofstream archivo("clientes.dat", ios::binary | ios::app);
	archivo.write(reinterpret_cast<char*>(&c), sizeof(Cliente));
	archivo.close();
	
	cout << "Cliente creado\n";
}

void leerClientes(Cliente clientes[], int& numClientes) {
	ifstream archivo("clientes.dat", ios::binary);
	numClientes = 0;
	
	while (archivo.read(reinterpret_cast<char*>(&clientes[numClientes]), sizeof(Cliente)) && numClientes < MAX_CLIENTES) {
		numClientes++;
	}
	archivo.close();
}

void mostrarClientes(const Cliente clientes[], int numClientes) {
	cout << "\n=== LISTADO DE CLIENTES ===\n";
	for (int i = 0; i < numClientes; i++) {
		cout << "Cód: " << clientes[i].codigo << " | " 
		<< clientes[i].nombre << " | " 
		<< clientes[i].tipoServicio << " | " 
		<< clientes[i].estado << " | Plan: " << clientes[i].codigoPlan << endl;
	}
}

void actualizarEstadoCliente(Cliente clientes[], int numClientes) {
	int codigo;
	cout << "Código cliente: "; cin >> codigo;
	
	for (int i = 0; i < numClientes; i++) {
		if (clientes[i].codigo == codigo) {
			cout << "Nuevo estado (Activo/Suspendido): "; 
			cin >> clientes[i].estado;
			
			ofstream archivo("clientes.dat", ios::binary);
			for (int j = 0; j < numClientes; j++) {
				archivo.write(reinterpret_cast<char*>(&clientes[j]), sizeof(Cliente));
			}
			archivo.close();
			cout << "Estado actualizado\n";
			return;
		}
	}
	cout << "Cliente no encontrado\n";
}

void eliminarCliente(Cliente clientes[], int& numClientes, int codigo) {
	for (int i = 0; i < numClientes; i++) {
		if (clientes[i].codigo == codigo) {
			for (int j = i; j < numClientes - 1; j++) {
				clientes[j] = clientes[j + 1];
			}
			numClientes--;
			
			ofstream archivo("clientes.dat", ios::binary);
			for (int k = 0; k < numClientes; k++) {
				archivo.write(reinterpret_cast<char*>(&clientes[k]), sizeof(Cliente));
			}
			archivo.close();
			cout << "Cliente eliminado\n";
			return;
		}
	}
	cout << "Cliente no encontrado\n";
}

void buscarPorCodigo(const Cliente clientes[], int numClientes, int codigo) {
	for (int i = 0; i < numClientes; i++) {
		if (clientes[i].codigo == codigo) {
			cout << "Cliente: " << clientes[i].nombre 
			<< " - Estado: " << clientes[i].estado 
			<< " - Servicio: " << clientes[i].tipoServicio << endl;
			return;
		}
	}
	cout << "No encontrado\n";
}

void leerPlanes(Plan planes[], int& numPlanes) {
	ifstream archivo("planes.txt");
	numPlanes = 0;
	
	if (!archivo) {
		cout << "Archivo planes.txt no encontrado, creando datos de ejemplo...\n";
		ofstream crear("planes.txt");
		crear << "1 Internet_Básico 50 25.99\n";
		crear << "2 Internet_Premium 100 45.99\n";
		crear << "3 Telefonía 1000 15.99\n";
		crear << "4 Combo 100 35.99\n";
		crear.close();
		archivo.open("planes.txt");
	}
	
	string linea;
	while (getline(archivo, linea) && numPlanes < MAX_PLANES) {
		istringstream iss(linea);
		iss >> planes[numPlanes].codigo >> planes[numPlanes].nombre 
		>> planes[numPlanes].velocidadMinutos >> planes[numPlanes].precioMensual;
		numPlanes++;
	}
	archivo.close();
}

void mostrarPlanes(const Plan planes[], int numPlanes) {
	cout << "\n=== PLANES DISPONIBLES ===\n";
	for (int i = 0; i < numPlanes; i++) {
		cout << "Cód: " << planes[i].codigo << " | " 
		<< planes[i].nombre << " | " 
		<< planes[i].velocidadMinutos << "Mbps/Min | $" 
		<< fixed << setprecision(2) << planes[i].precioMensual << endl;
	}
}

double calcularTotalFacturado(const Cliente clientes[], int numClientes, const Plan planes[], int numPlanes) {
	double total = 0;
	for (int i = 0; i < numClientes; i++) {
		if (clientes[i].estado == "Activo") {
			for (int j = 0; j < numPlanes; j++) {
				if (clientes[i].codigoPlan == planes[j].codigo) {
					total += planes[j].precioMensual;
					break;
				}
			}
		}
	}
	return total;
}

void generarFacturacion(const Cliente clientes[], int numClientes, const Plan planes[], int numPlanes) {
	ofstream archivo("facturacion.csv");
	archivo << "Código,Nombre,Precio,Total\n";
	
	for (int i = 0; i < numClientes; i++) {
		if (clientes[i].estado == "Activo") {
			for (int j = 0; j < numPlanes; j++) {
				if (clientes[i].codigoPlan == planes[j].codigo) {
					archivo << clientes[i].codigo << "," << clientes[i].nombre << ","
					<< planes[j].precioMensual << "," << planes[j].precioMensual << "\n";
					break;
				}
			}
		}
	}
	archivo.close();
	cout << "Facturación generada en facturacion.csv\n";
}

int main() {
	Cliente clientes[MAX_CLIENTES];
	Plan planes[MAX_PLANES];
	int numClientes = 0, numPlanes = 0;
	
	cout << "=== SISTEMA GESTIÓN EMPRESA TELEFONÍA ===\n";
	
	leerClientes(clientes, numClientes);
	leerPlanes(planes, numPlanes);
	
	int opcion;
	do {
		cout << "\n=== MENÚ PRINCIPAL ===\n";
		cout << "1. Crear cliente\n";
		cout << "2. Mostrar clientes\n";
		cout << "3. Mostrar planes\n";
		cout << "4. Actualizar estado cliente\n";
		cout << "5. Eliminar cliente\n";
		cout << "6. Buscar cliente por código\n";
		cout << "7. Generar facturación\n";
		cout << "8. Total facturado\n";
		cout << "0. Salir\n";
		cout << "Opción: ";
		cin >> opcion;
		
		switch(opcion) {
			case 1: crearCliente(clientes, numClientes); break;
			case 2: mostrarClientes(clientes, numClientes); break;
			case 3: mostrarPlanes(planes, numPlanes); break;
			case 4: actualizarEstadoCliente(clientes, numClientes); break;
			case 5: {
				int cod; cout << "Código a eliminar: "; cin >> cod;
				eliminarCliente(clientes, numClientes, cod);
				break;
			}
			case 6: {
				int cod; cout << "Código a buscar: "; cin >> cod;
				buscarPorCodigo(clientes, numClientes, cod);
				break;
			}
			case 7: generarFacturacion(clientes, numClientes, planes, numPlanes); break;
			case 8: {
				double total = calcularTotalFacturado(clientes, numClientes, planes, numPlanes);
				cout << "Total facturado mensual: $" 
				<< fixed << setprecision(2) << total << endl;
				break;
			}
			case 0: cout << "¡Gracias por usar el sistema!\n"; break;
			default: cout << "Opción inválida\n";
		}
	} while (opcion != 0);
	
	return 0;
}
