#include <iostream>
#include <fstream>
#include <string>
#include <iomanip>

using namespace std;

struct Publicacion {
	int codigo;
	string titulo;
	int añoPublicacion;
	string estado;
	string tipo; 
};

const int MAX_PUBLICACIONES = 100;

void registrarPublicacion(Publicacion publicaciones[], int& numPub, const string& tipo) {
	if (numPub >= MAX_PUBLICACIONES) {
		cout << "Máximo de publicaciones alcanzado\n";
		return;
	}
	
	Publicacion p;
	cout << "Código: "; cin >> p.codigo;
	cout << "Título: "; cin.ignore(); getline(cin, p.titulo);
	cout << "Año de publicación: "; cin >> p.añoPublicacion;
	p.estado = "No Prestado";
	p.tipo = tipo;
	
	publicaciones[numPub] = p;
	numPub++;

	ofstream archivo("temp.dat", ios::binary | ios::app);
	archivo.write(reinterpret_cast<const char*>(&p), sizeof(Publicacion));
	archivo.close();
	
	cout << "Publicación registrada\n";
}

void prestarPublicacion(Publicacion publicaciones[], int numPub, int codigo) {
	for (int i = 0; i < numPub; i++) {
		if (publicaciones[i].codigo == codigo) {
			if (publicaciones[i].estado == "No Prestado") {
				publicaciones[i].estado = "Prestado";
				cout << "Publicación prestada exitosamente\n";
			} else {
				cout << "La publicación ya está prestada\n";
			}
			return;
		}
	}
	cout << "Publicación no encontrada\n";
}

void devolverPublicacion(Publicacion publicaciones[], int numPub, int codigo) {
	for (int i = 0; i < numPub; i++) {
		if (publicaciones[i].codigo == codigo) {
			if (publicaciones[i].estado == "Prestado") {
				publicaciones[i].estado = "No Prestado";
				cout << "Publicación devuelta exitosamente\n";
			} else {
				cout << "La publicación no está prestada\n";
			}
			return;
		}
	}
	cout << "Publicación no encontrada\n";
}

void mostrarPublicacion(const Publicacion& p) {
	cout << left << setw(5) << p.codigo 
	<< setw(30) << p.titulo 
	<< setw(6) << p.añoPublicacion
	<< setw(12) << p.estado 
	<< p.tipo << endl;
}

void mostrarTodas(const Publicacion publicaciones[], int numPub) {
	cout << "\n=== TODAS LAS PUBLICACIONES ===\n";
	cout << left << setw(5) << "CÓD" 
	<< setw(30) << "TÍTULO" 
	<< setw(6) << "AÑO"
	<< setw(12) << "ESTADO" 
	<< "TIPO" << endl;
	cout << string(55, '-') << endl;
	
	for (int i = 0; i < numPub; i++) {
		mostrarPublicacion(publicaciones[i]);
	}
}

void mostrarPrestadas(const Publicacion publicaciones[], int numPub) {
	cout << "\n=== PUBLICACIONES PRESTADAS ===\n";
	bool hayPrestadas = false;
	
	for (int i = 0; i < numPub; i++) {
		if (publicaciones[i].estado == "Prestado") {
			mostrarPublicacion(publicaciones[i]);
			hayPrestadas = true;
		}
	}
	
	if (!hayPrestadas) {
		cout << "No hay publicaciones prestadas\n";
	}
}

void mostrarStock(const Publicacion publicaciones[], int numPub) {
	cout << "\n=== PUBLICACIONES EN STOCK ===\n";
	bool hayStock = false;
	
	for (int i = 0; i < numPub; i++) {
		if (publicaciones[i].estado == "No Prestado") {
			mostrarPublicacion(publicaciones[i]);
			hayStock = true;
		}
	}
	
	if (!hayStock) {
		cout << "No hay publicaciones en stock\n";
	}
}

void guardarPrestados(const Publicacion publicaciones[], int numPub) {
	ofstream archivo("LibrosPrestados.txt");
	archivo << "Código,Título,Año,Estado\n";
	
	for (int i = 0; i < numPub; i++) {
		if (publicaciones[i].estado == "Prestado") {
			archivo << publicaciones[i].codigo << ","
			<< publicaciones[i].titulo << ","
			<< publicaciones[i].añoPublicacion << ","
			<< publicaciones[i].estado << "\n";
		}
	}
	archivo.close();
	cout << "Archivo LibrosPrestados.txt generado\n";
}

void guardarStock(const Publicacion publicaciones[], int numPub) {
	ofstream archivo("LibrosEnStock.txt");
	archivo << "Código,Título,Año,Estado\n";
	
	for (int i = 0; i < numPub; i++) {
		if (publicaciones[i].estado == "No Prestado") {
			archivo << publicaciones[i].codigo << ","
			<< publicaciones[i].titulo << ","
			<< publicaciones[i].añoPublicacion << ","
			<< publicaciones[i].estado << "\n";
		}
	}
	archivo.close();
	cout << "Archivo LibrosEnStock.txt generado\n";
}

void cargarPublicaciones(Publicacion publicaciones[], int& numPub) {
	ifstream archivo("temp.dat", ios::binary);
	numPub = 0;
	
	while (archivo.read(reinterpret_cast<char*>(&publicaciones[numPub]), sizeof(Publicacion)) && 
		   numPub < MAX_PUBLICACIONES) {
		numPub++;
	}
	archivo.close();
}

int main() {
	Publicacion publicaciones[MAX_PUBLICACIONES];
	int numPub = 0;
	
	cout << "=== SISTEMA GESTIÓN BIBLIOTECA ===\n";

	cargarPublicaciones(publicaciones, numPub);
	
	int opcion;
	do {
		cout << "\n=== MENÚ PRINCIPAL ===\n";
		cout << "1. Registrar Libro\n";
		cout << "2. Registrar Revista\n";
		cout << "3. Prestar publicación\n";
		cout << "4. Devolver publicación\n";
		cout << "5. Mostrar todas las publicaciones\n";
		cout << "6. Mostrar prestadas\n";
		cout << "7. Mostrar en stock\n";
		cout << "0. Generar archivos y salir\n";
		cout << "Opción: ";
		cin >> opcion;
		
		switch(opcion) {
			case 1: 
			registrarPublicacion(publicaciones, numPub, "Libro");
			break;
			case 2: 
			registrarPublicacion(publicaciones, numPub, "Revista");
			break;
			case 3: {
				int codigo;
				cout << "Código a prestar: ";
				cin >> codigo;
				prestarPublicacion(publicaciones, numPub, codigo);
				break;
			}
			case 4: {
				int codigo;
				cout << "Código a devolver: ";
				cin >> codigo;
				devolverPublicacion(publicaciones, numPub, codigo);
				break;
			}
			case 5: 
			mostrarTodas(publicaciones, numPub);
			break;
			case 6: 
			mostrarPrestadas(publicaciones, numPub);
			break;
			case 7: 
			mostrarStock(publicaciones, numPub);
			break;
			case 0: 
			cout << "Generando archivos...\n";
			guardarPrestados(publicaciones, numPub);
			guardarStock(publicaciones, numPub);
			cout << "¡Gracias por usar el sistema de biblioteca!\n";
			break;
			default: 
			cout << "Opción inválida\n";
		}
	} while (opcion != 0);
	
	return 0;
}
